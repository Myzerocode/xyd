name: tests:node-support

on:
  push:
    tags:
      - 'v*.*.*' # stable e.g. v0.1.0
  workflow_dispatch: # manual trigger

jobs:
  test:
    name: ðŸ§ª Node Support Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [22.12.0]

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9.10.0

    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

    - name: Setup pnpm cache
      uses: actions/cache@v4
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: Install dependencies
      run: pnpm i

    - name: Install Playwright browsers
      run: pnpm exec playwright install

    - name: ðŸ”§ Install n version manager
      run: |
        npm install -g n
        # Set N_PREFIX to a directory we can write to
        echo "N_PREFIX=$HOME/.n" >> $GITHUB_ENV
        export N_PREFIX=$HOME/.n
        mkdir -p $HOME/.n

    - name: ðŸ”§ Install xyd-js globally via bun
      run: |
        # Install bun 
        curl -fsSL https://bun.com/install | bash -s "bun-v1.2.20"
        export BUN_INSTALL="$HOME/.bun"
        export PATH="$BUN_INSTALL/bin:$PATH"
        
        # Install xyd-js globally
        bun add -g xyd-js

    - name: ðŸ§ª Run Node Support tests
      run: pnpm run test:node-support
